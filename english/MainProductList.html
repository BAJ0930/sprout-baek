<?
	include_once $_SERVER['DOCUMENT_ROOT']."/_common.php";
	ob_clean();

	$fnbrand = fnLoadBrandName();

	$addID=$s2;	//-- 첫페이지는 두개의 페이지가 함께 출력되므로 checkbox 에 추가 구분자를 붙여준다
	
	$s2 = htmlspecialchars(trim($s2));
	if(strlen($cateIDX) > 4) exit;
	
	if($s2 == "1"){
		if($cateIDX)
			$fnCateIDX = " AND (Pcategory2 like '".$cateIDX."%' OR Pcategory3 like '".$cateIDX."%') ";
		else 
			$fnCateIDX = "";

		$sql = " SELECT * FROM 2011_productInfo ";
		$sql .= " WHERE Pshop = '" . $shopID . "' AND Pdeleted = 0 AND PenglishView = 0 ".$fnCateIDX;
		$sql .= " AND Pprice3 > 0 AND Pagree = 1 AND Pstate < 10 AND PstockCount > 0";
		$sql .= " ORDER BY Pregdate desc, IDX desc ";
		$sql .= " LIMIT 0, 10 ";
	} else if($s2 == "2"){
		if($cateIDX)
			$fnCateIDX = " AND (b.Pcategory2 like '".$cateIDX."%' OR b.Pcategory3 like '".$cateIDX."%') ";
		else 
			$fnCateIDX = "";
		
		$sql = " SELECT b.* FROM nBest AS a LEFT JOIN 2011_productInfo AS b ON a.pCode = b.IDX ";
		$sql .= " WHERE b.Pshop = '" . $shopID . "' AND b.Pdeleted = 0 AND b.PenglishView = 0 " . $fnCateIDX;
		$sql .= " AND b.Pprice3 > 0 AND b.Pagree = 1 AND b.Pstate < 10 AND b.PstockCount > 0 ";
		$sql .= " GROUP BY b.IDX ";
		$sql .= " ORDER BY a.pCnt DESC LIMIT 0, 10";
	} else {
		echo "error";
		exit;
	}

	$result = sql_query($sql);
	
	$kk = 0;
	while($rs=sql_fetch_array($result)){
		$kk ++;

		foreach ($rs as $fieldName => $fieldValue){$fieldName = "db" . $fieldName;$$fieldName = $fieldValue;}

		$imgUrl = getImgUrl($dbPsaveFile1);
		$pImg = "<img src='".$imgUrl."' border='0' />";
		
		$dbPready = getProductReady($dbIDX);
		$dbPstockCount = $dbPstockCount - $dbPready;
		$getInfo = getListInfo($rs, $dbPstockCount);
		
		$icon = $getInfo['icon'];
		$icon2 = $getInfo['icon2'];
		$icon3 = $getInfo['icon3'];

		$boxin2 = $getInfo['boxin2'];
		$nCount = $getInfo['nCount'];
		$addCheckMsg = $getInfo['addCheckMsg'];
		$dbPstockCount = $getInfo['dbPstockCount'];
		if($_Minus == 1) $dbPorderMinus = 1;	

		$priceInfo = fnCalPrice($dbPprice3,$rs);
		
		$link = "<a href='/product/view.html?qIDX=" . $dbIDX . "' title='" . $dbPname . "'>";
		$dbPname = strcut_utf8($dbPname,35,"","..");

		$btnDisabled = "";
		if($dbPstockCount < 1  && $dbPorderMinus != 1) $btnDisabled = " disabled ";

		if($s2 == "1"){
			if($kk < 11) $boardNone = "";
			else $borderNone = " none";
		} else if($s2 == "2"){
			if($kk < 6) $boardNone = "";
			else $borderNone = " none";
		}
?>


<div class="box <?=$borderNone?>">
    <span class="icon boxin"><?= $boxin2 ?></span>
    <?=$link?>
    <div style="position:relative"> 
        <?php if ($dbPicon1 > 5): ?>
            <div style="position:absolute; left:6px; top:6px; width:62px; height:67px; background-repeat: no-repeat; background-image: url('/img/circle160_<?=$dbPicon1?>.png?2209');"></div>
        <?php endif; ?>
        <p class="imgOver"><?=$pImg?></p>
    </div>
    </a>

    <span class="tit"><?=$fnbrand[$dbBRIDX]?></span>
    <span class="tit2">Item No. <?=$dbIDX?></span>
    <span class="text"><?=$dbPengName?></span>
    <? if($MID) { ?>
    <div class="price-dollar">
        <font class="sale">USD <?=$priceInfo["dollar_txt"]?></font>
        <font class="point"><strong><span style="font-size: 13px; font-weight: 400; color: #555555;">USD </span> <?=$priceInfo["dcDollar_txt"]?></strong></font>
    </div>
    <span class="price">
        <?php if ($priceInfo["dcPer"]): ?>
            <font class="percent"><strong><?=$priceInfo["dcPer"]?></strong>%<span class="max"><?=fnGETPricePer($rs); ?></span></font>
        <?php endif; ?>
    </span>
    <? } else { ?>
        <div class="before-price-wrap">
            <div class="price-notice">Login To See Price</div>
        </div>
    <? } ?>
    <div class="amount_box">
        <div class="arrow">
            <input type="checkbox" name="inPcheck<?=$addID?>" id="inPcheck<?=$addID?>" class="check" value="<?=$dbIDX?>" <?=$btnDisabled?> <?=$addCheckMsg?> />
            <img src="/img/ico/ico-item-minus.svg" alt="down" id="btn_minus" style="cursor:pointer" onclick="fnPcountPlus(this,-1)" <?=$btnDisabled?>>
            <input name="inPcount" type="text" class="amount" id="inPcount" size="3" maxlength="3" value="<?=$nCount?>" onkeydown="onlyNum()" onblur="fnPcountCheck(this)" <?=$btnDisabled?> />
            <img src="/img/ico/ico-item-plus.svg" alt="up" id="btn_plus" style="cursor:pointer" onclick="fnPcountPlus(this,1)" <?=$btnDisabled?>>
        </div>
        <?php
            if($MID){
                $rsFV = sql_fetch("select IDX from 2011_favoriteInfo where MID='" . htmlspecialchars($MID) . "' and FAtype='1' and FAIDX='" . htmlspecialchars($dbIDX) . "'");
                $rsFVonClick = "toggleFavorite(this,'".$dbIDX."');";
            } else {
                $rsFVonClick = "alert('After you login, you will be able to use your wishlist.');";						
            }
        ?>
        <div class="flex-row-gap6">
            <!--<img src='/img/ico/btn-addToWish<?php if($rsFV['IDX']) { echo "-added"; } ?>.svg' alt="Add to Wishlist" style="cursor:pointer;" onClick="<?=$rsFVonClick?>" <?=$btnDisabled?>>-->
            <img src='/img/ico/btn-addToCart.svg' alt="Add to Cart" style="cursor:pointer;" id="btn_addCart" onclick="fnCartIn(<?=$dbIDX?>,this)" <?=$btnDisabled?>>
        </div>
    </div>
    <span class="icon itemBadge"><?= $icon . $icon2 . $icon3 ?></span>

    <input type="hidden" name="inMaxStock" id="inMaxStock" value="<?=$dbPstockCount?>">
    <input type="hidden" name="inPorderMinus" id="inPorderMinus" value="<?=$dbPorderMinus?>">
</div>

<? } ?>

<script>
$(document).ready(function(){
	$('.imgOver').append('<em></em>');
	$('.box').mouseenter(function(){
		$(this).find('.imgOver em').show();
	});
	$('.box').mouseleave(function(){
		$(this).find('.imgOver em').hide();
	});
});
</script> 