<?
	include_once $_SERVER['DOCUMENT_ROOT']."/_common.php";

	include_once $_SERVER['DOCUMENT_ROOT']."/top.html";
	
	include_once $_SERVER['DOCUMENT_ROOT']."/mypage/common.html";	

	#======== 날짜 구하기 =======================
	//-- 오늘
	$day11 = date("Y-m-d");
	$day12 = date("Y-m-d");

	//-- 어제
	$day21 =date("Y-m-d",strtotime("-1 day"));
	$day22 =date("Y-m-d",strtotime("-1 day"));

	//-- 이번주
	$day31 =date("Y-m-d",strtotime("last Monday"));
	$day32 =date("Y-m-d",strtotime("next Sunday"));

	//-- 지난주
	$day41 =date("Y-m-d",strtotime("-1 week last Monday"));
	$day42 =date("Y-m-d",strtotime("-1 week next Sunday"));

	//-- 이번달
	$day51 =date("Y-m-d",mktime(0,0,0,date("m"),1,date("Y")));
	$day52 =date("Y-m-d",mktime(0,0,0,date("m"),31,date("Y")));

	//-- 최근한주
	$day61 =date("Y-m-d",strtotime("-6 day"));
	$day62 =date("Y-m-d");

	//-- 최근한달
	$day71 =date("Y-m-d",strtotime("-30 day"));
	$day72 =date("Y-m-d");

	// -- 한달
	$day81 =date("Y-m-d",strtotime("-30 day"));
	$day82 =date("Y-m-d");

?>
<link rel="stylesheet" type="text/css" href="/mypage/mypage.css?250222">
<link href='/css/button.css' rel='stylesheet' type='text/css'>

<!-- 마이페이지 시작 --->    
<div id="wrap">

	<?	include_once $_SERVER['DOCUMENT_ROOT']."/mypage/menu.html"; ?>
	
	<!-- mypageMain -->
	<div id="mypageMain">
	
	<? include_once $_SERVER['DOCUMENT_ROOT']."/mypage/top.html"; ?>      
	
	<?			
		/*=======================================================================================
		회원 처리
		=======================================================================================*/
		if($MID){
			$StateCount[0]=0;
			$StateCount[1]=0;
			$StateCount[2]=0;
			$StateCount[3]=0;
			
			/*=======================================================================================
			현 주문상태 구하기  1) 결제 관련 (배송준비중 / 배송완료된 건은 제외)
			=======================================================================================*/
			$sql = "select min(OpayState) as OpayState from 2011_orderInfo as a left join 2011_orderDeliveryInfo as b on a.IDX = b.OIDX where  MID='" . $uid . "' and a.Odeleted=0 and ODstate=1 and a.OpayState<>88 group by a.IDX";
			$result = sql_query($sql);
			while($rs = sql_fetch_array($result)) {
				if($rs['OpayState']==99)$StateCount[1]++;
				else $StateCount[$rs['OpayState']-1]++;						
			}
			/*=======================================================================================
			현 주문상태 구하기 2) 배송관련 (입금여부는 상관없이 단지 배송상태를 기준으로 체크)
			=======================================================================================*/
			$sql = "select min(ODstate) as ODstate from 2011_orderInfo as a left join 2011_orderDeliveryInfo as b on a.IDX = b.OIDX where  MID='" . $uid . "' and a.Odeleted=0 and ODstate<>1 and a.OpayState<>88  group by a.IDX";
			$result = sql_query($sql);
			while($rs = sql_fetch_array($result)) {
				if($rs['ODstate']==2) $StateCount[2]++;
				else $StateCount[$rs['ODstate']-1]++;
				//$StateCount[$rs["ODstate"]-1]++;
			}
			
			for($k=0;$k<4;$k++)if(!$StateCount[$k])$StateCount[$k]=0;
			
			//-- 기본 조건문
			$addWhere = " a.MID='" . $MID . "' ";
		}//-- if MID End
		else
		{
			/*=======================================================================================
			비회원 처리
			=======================================================================================*/
			$Ocode = substr($Ocode,0,7) . "-" . substr($Ocode,7);
			$StateCount[0]=0;
			$StateCount[1]=0;
			$StateCount[2]=0;
			$StateCount[3]=0;
			
			/*=======================================================================================
			현 주문상태 구하기 - 주문번호를 기준으로 상태 불러오기
			=======================================================================================*/
			$sql = "select OdepositCheck,count(IDX) as cnt from 2011_orderInfo where Ocode='" . $Ocode . "'  and Odeleted=0  and a.OpayState<>88  group by OdepositCheck ";
			$rs = sql_fetch($sql);
			$StateCount[$rs['OdepositCheck']-1] = $rs['cnt'];
			
			//-- 기본 조건문
			$addWhere = " a.Ocode='" . $Ocode . "' ";
		}
		
		/*=======================================================================================
		검색 조건문 만들기
		=======================================================================================*/
		
		if($s9 || $s10) {	
			if($s9) {
				$d1 = explode("-",$s9);
				$date1 = mktime(0,0,0,$d1[1],$d1[2],$d1[0]);
			}
			if($s10) {
				$d2 = explode("-",$s10);
				$date2 = mktime(0,0,0,$d2[1],($d2[2]+1),$d2[0]);
			}			
		} else {
			$s9 = $day81;
			$d1 = explode("-",$s9);
			$date1 = mktime(0,0,0,$d1[1],$d1[2],$d1[0]);
			
			$s10 = $day82;
			$d2 = explode("-",$s10);
			$date2 = mktime(0,0,0,$d2[1],($d2[2]+1),$d2[0]);
		}
		
		if($s9) {
			if($addWhere)$addWhere.=" and ";
			
			if($s4 == 2){
				$addWhere.=" Odeleted>='" . $date1 . "' ";
			} else {
				$addWhere.=" Oregdate>='" . $date1 . "' ";
			}
		}
		
		if($s10) {
			if($addWhere)$addWhere.=" and ";
			
			if($s4 == 2){
				$addWhere.=" Odeleted<'" . $date2 . "' ";
			} else {
				$addWhere.=" Oregdate<'" . $date2 . "' ";
			}
		}

		if($s3) {
			if($addWhere)$addWhere.=" and ";
			$addWhere.=" Oname ='" . urldecode($s3) . "' ";
		}
		
		if($addWhere)$addWhere=" and " . $addWhere;

		/*=======================================================================================
		리스트 구하기 구하기
		=======================================================================================*/
		$sql = " SELECT a.* , b.OIDX, sum( AMT + OusePoint + OuseGift + OuseCoupon ) AS AMT, avg( ODstate ) AS ODstate, ODcode, count( ODcode ) AS ODcount, MemoCount, ODdate FROM  ";
		$sql .= " ( SELECT m.* FROM 2011_orderInfo AS m LEFT JOIN 2011_orderDeliveryInfo AS g ON m.IDX = g.OIDX WHERE m.Odeleted=1 and m.OcancelType > 0 ";
		$sql .= str_replace("a.MID","m.MID",$addWhere) . " ORDER BY m.IDX DESC ) AS a ";
		$sql .= " LEFT JOIN 2011_orderPayment AS b ON a.IDX = b.OIDX ";
		$sql .= " LEFT JOIN 2011_orderDeliveryInfo AS d ON a.IDX = d.OIDX ";
		$sql .= " LEFT JOIN ( SELECT OIDX, count( IDX ) AS MemoCount FROM 2011_orderMemo WHERE OMtype = 1 AND OMdeleted = 0 GROUP BY OIDX ) AS e ON a.IDX = e.OIDX GROUP BY a.IDX ORDER BY a.IDX DESC  ";
		$result = sql_query($sql);
		$TotalCount = mysqli_num_rows($result);
		if (!$page) $page = 1;
		if (!$listSize) $listSize = 10;
		$CntPerPage = $listSize;
		$PagePerList = 5;
		$StartPos = ($page - 1) * $CntPerPage;
		$sql = str_replace(" ORDER BY m.IDX DESC ", " ORDER BY m.IDX DESC LIMIT ".($page - 1) * $CntPerPage.",".$CntPerPage, $sql);
		$result = sql_query($sql);
		
		$option = "&kind=deleted&listSize=".$listSize."&s3=".urlencode($s3)."&s4=".$s4."&s9=".$s9."&s10=".$s10;
?>

<div class="qa_list">
	<h3 style="padding-bottom:10px;"><img src="/img/mypage/tit_09.gif" alt="나의주문취소내역조회"></h3>

	<table border="0" cellspacing="0" cellpadding="0" style="width:100%; height:42px; border:0px;">
	<form name="xform" id="xform">
		<tr>
			<td style="padding:3px 0 0 0; margin:0px; border-bottom:0px;">
				<b>Recipient</b>
				<input type='text' value='<?=$s3?>' id='s3' name='s3' size=15>
				&nbsp;&nbsp;
				<select name="s4" id="s4">
					<option value="1" <? if($s4 == 1) echo "selected"; ?>>Order of date</option>
				</select>
				<input type='text' value='<?=$s9?>' id='s9' name='s9' readonly tabindex='-1' size=7 style='cursor:pointer;' >
				~
				<input type='text' value='<?=$s10?>' id='s10' name='s10' readonly tabindex='-1' size=7 style='cursor:pointer;' >
				&nbsp;&nbsp;
				<span class='button medium icon' style='margin-top:6px;'><span class='refresh'></span><input type='button' value='&nbsp;SEARCH&nbsp;' onclick='document.getElementById("xform").submit();'  /></span>
			</td>
		</tr>
	</table>
	</form>
	<table border="0" cellspacing="0" cellpadding="0" class="mypage-table">
	<tr>
		<th scope="col">Order No</th>
		<th scope="col">Order of date</th>
		<th scope="col" width="100">Recipient</th>
		<th scope="col">Total Amount</th>
		<th scope="col" width="140">Status Payment</th>
		<th scope="col" width="90">Cancel of date</th>
	</tr>
	<?
		while($rs=sql_fetch_array($result)){
			# DB 레코드 결과값 모두 변수로 전환
			foreach ($rs as $fieldName => $fieldValue){$fieldName = "db" . $fieldName;$$fieldName = $fieldValue;}
			
			if($dbOpayState==1 && $dbODstate==1)$StateStr = "Before Payment";
			else if($dbOpayState==2 && $dbODstate==1)$StateStr = "<font class=blue>Paid</font>";
			else if($dbODstate==2)$StateStr = "<font class=blue>Before Delivery</font>";
			else if($dbODstate>2 && $dbODstate<3)$StateStr = "On Delivery";
			else if($dbODstate==3)$StateStr = "<font class=blue>On Delivery</font>";
			else if($dbODstate>3 && $dbODstate<4)$StateStr = "On Delivery";
			else if($dbODstate==4)$StateStr = "Delivery Over";
			
			if($dbODdate && $dbODstate==4) $ODdate=date("y/m/d",$dbODdate);
			else $ODdate="-";
			
			if($dbODcode){
				$t = explode("##",$dbODcode);
				$l = sizeof($t);
				if($l>1)$deliveryStr = $t[0] . "<br>외 " . ($l-1) . " 건 ";
				else $deliveryStr = $t[0];
			} else {
				$deliveryStr = "";
			}
			
			if($dbOpayState==1)$PayState = "<font color=green>Before Payment</font>";
			if($dbOpayState==2)$PayState = "Paid";
			if($dbOpayState==99)$PayState = "<font color=blue>Paid";
			
			if($dbMemoCount)$Mcnt = "<a href='javascript:fnOpenMemo(" . $dbIDX . ",1,1)'><img src='/image_1/note.gif' align='absmiddle' border=0 alt='[" . $dbMemoCount . "] Memo.'></a>";
			else $Mcnt="";
			
			/*$PAMT = "0";
			if($dbAMT > 0) $PAMT = number_format($dbAMT)."원";
			if($dbOusePoint > 0) $PAMT .= "<br>포인트:". number_format($dbOusePoint)."원";
			if($dbOuseGift > 0 ) $PAMT .= "<br>상품권:". number_format($dbOuseGift)."원";
			if($dbOuseCoupon > 0)  $PAMT .= "<br>쿠폰:". number_format($dbOuseCoupon)."원";*/
			if($dbOpayState==1 && $dbODstate==1){
				$payMode = "cash";
			} else if($dbOpayState == 2 && $dbODstate==1){
				$payMode = "card";
			} else {
				$payMode = "";
			}
			
			if($dbOcancelType==1)$dbOcancelReason="고객변심";
			else if($dbOcancelType==2)$dbOcancelReason="재고부족";
			else if($dbOcancelType==3)$dbOcancelReason="입금지연";
			else if($dbOcancelType==4)$dbOcancelReason="배송지연";
			
	?>
	<tr id='orderRow<?=$dbIDX?>'>
		<td style="padding:0 4px;"><?=$Mcnt?><a href='shippingDetail.html?kind=deleted&Ocode=<?=$dbOcode?>&page=<?=$page?><?=$option?>'><font color="blue"><?=$dbOcode?></font></a></td>
		<td><?=date("y/m/d H:i",$dbOregdate)?></td>
		<td style="line-height:130%;"><?=$dbOname?></td>
		<td>USD <?=$dbAMT?></td>
		<td style="line-height:16px;"><font color=red>Cancellation<br>has been completed</font></td>
		<td><?=date("y/m/d H:i",$dbOcancelTime)?></td>
	</tr>
	<? } ?>
	</table>

	<!-- //마이페이지 주문확인/배송조회 -->
	</div>        

	<div align="center" id="paging"><? echo page_nav($TotalCount,$CntPerPage,$PagePerList,$page,$option); ?></div>
	</div>

</div>
<!-- //마이페이지 끝 ---> 

<script>
$(function() {
	$( "#s9, #s10" ).datepicker({
		dateFormat: 'yy-mm-dd',
		prevText: '이전 달',
		nextText: '다음 달',
		monthNames: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
		monthNamesShort: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
		dayNames: ['일','월','화','수','목','금','토'],
		dayNamesShort: ['일','월','화','수','목','금','토'],
		dayNamesMin: ['일','월','화','수','목','금','토'],
		showMonthAfterYear: true,
		changeMonth: true,
		changeYear: true,
		yearRange: 'c-2:c+2',
		yearSuffix: '년'
	});
});
</script>
 
<?
	include_once $_SERVER['DOCUMENT_ROOT']."/footer.html";
?>