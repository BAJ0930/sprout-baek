
<?
    
?>

<style>
    #mypageMain {width: 1200px; margin-left: 0;}
    #mypageMain .info_help {width: 1200px; height: auto; flex-direction: column;}
    #mypageMain .info_help > div {width: 100%;}
    #mypageMain .info_help .content-items {text-align: center; flex-direction: column; gap: 8px; position: relative;}
    #mypageMain .info_help ul {gap: 16px;}
    #mypageMain .info_help ul li {width: 168px; flex: 1; border: 0; box-shadow: 0 4px 16px rgba(0,0,0,0.15);}
    #mypageMain .info_help .info-total {width: 208px; font-size: 16px; font-weight: 600;}
    #mypageMain .info_help .info-total strong {color: #005bf1; font-weight: 700; font-size: 22px;}
    #mypageMain .info_help .info-basic strong {color: #333333; font-size: 18px; font-family: "PLBold"; display: block; margin-bottom: 8px;}
    #mypageMain .info_help .info-basic span {font-size: 14px; display: flex; align-items: center; gap: 6px; width: auto;}
    #mypageMain .info_help .info-basic span img {height: 16px;}
    #mypageMain .info_help .my-button-list li {cursor: pointer;}
    #mypageMain .info_help .my-button-list .content-items span {font-size: 16px; font-weight: 600; color: #333333;}
    #mypageMain .info_help .my-button-list .content-items .count {
        background: #ff3838; line-height: 14px; padding: 2px 4px 0; border-radius: 8px; color: #ffffff; min-width: 16px;
        font-size: 11px; font-weight: 600; position: absolute; top: -8px; right: 40px;
    }

    #mypageMain .qa_list table {border: 0;}
    #mypageMain .qa_list th {background: #f8f8f8; border-bottom: 0; font-weight: 600;}
    #mypageMain .qa_list th:first-child {border-radius: 8px 0 0 8px;}
    #mypageMain .qa_list th:last-child {background: #f8f8f8; border-radius: 0 8px 8px 0;}
    #mypageMain .qa_list td {display: table-cell; text-align: center; font-size: 16px; line-height: 1.5; padding: 12px 0; border-bottom: 1px solid #dedede;}
    #mypageMain .qa_list td.stock-status {text-align: left;}
    #mypageMain .qa_list td .btn-style {margin: 4px auto 0; width: fit-content;}

    span.order-number {font-weight: 600;}
    span.order-price {font-weight: 700; color: #111111; font-size: 18px; display: block;}
    span.order-items {color: #888888;}
    span.done {color: #36B636; font-weight: 600;}
    span.shipped {color: #FF7621; font-weight: 600;}
    span.pending {color: #333333; font-weight: 600;}

    .inquiry-list .inquiry-item {padding: 12px 0; border-bottom: 1px solid #dedede;}
    .inquiry-list .inquiry-item .status {display: inline-block; line-height: 1; padding: 4px 10px; border-radius: 50px; font-family: "PLBold"; font-size: 12px;}
    .inquiry-list .inquiry-item .in-progress {background: #FFF2C6; color: #D3A300;}
    .inquiry-list .inquiry-item .answered {background: #C6FFD7; color: #00AD34;}
    .inquiry-list .inquiry-item .title {font-size: 16px; font-weight: 600; margin-left: 4px;}
    .inquiry-list .inquiry-item .message {
        color: #888888; font-size: 15px; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 840px;
    }
    .inquiry-list .inquiry-item .date {color: #888888; font-size: 15px; text-align: right;}

    #mypageMain .qa_list .wishlist-container {margin: auto auto 64px;}
    #mypageMain .qa_list .wishlist-container table .item-info {display: flex; align-items: center; gap: 16px; text-align: left;}
    #mypageMain .qa_list .wishlist-container table .item-info > a {display: block; width: 72px; height: 72px; border-radius: 8px; overflow: hidden;}
    #mypageMain .qa_list .wishlist-container table .item-info > a > img {width: 100%; height: auto;}
    #mypageMain .qa_list .wishlist-container table .item-info > a > img .price {font-size: 16px; font-weight: 600; color: #111111;}
    #mypageMain .qa_list .wishlist-container table .item-info .features {margin-bottom: 4px;}
    #mypageMain .qa_list .wishlist-container table .item-info .features span {
        padding-right: 8px; border-right: 1px solid #dedede; line-height: 15px; font-size: 15px; color: #888888; margin-right: 4px;
    }
    #mypageMain .qa_list .wishlist-container table .item-info .features span:last-child {border: 0;}
    #mypageMain .qa_list .wishlist-container table .price-wrap .price {font-weight: 600; line-height: 1; color: #111111; margin-bottom: 8px;}
    #mypageMain .qa_list .wishlist-container table .price-wrap .btn-style {margin: 6px auto 0 auto;}
    #mypageMain .qa_list .wishlist-container table .price-wrap .discount {display: block; font-size: 14px; color: #888888;}

    #mypageMain .qa_list .wishlist-container table .stock-status {font-size: 13px; color: #888888; text-align: left;}
    #mypageMain .qa_list .wishlist-container table .stock-status .in-stock {color: #00AD34;}
    #mypageMain .qa_list .wishlist-container table .stock-status .low-stock,
    #mypageMain .qa_list .wishlist-container table .stock-status .sold-out {color: #ffffff; font-weight: 600; padding: 2px 2px 0px; border-radius: 2px; font-size: 12px; display: inline-block; width: fit-content; margin-left: 4px; height: 15px; line-height: 1;}
    #mypageMain .qa_list .wishlist-container table .stock-status .low-stock {background: #ff3838;}
    #mypageMain .qa_list .wishlist-container table .stock-status .sold-out {background: #333333;}
    
    .subTitle-B .btn-seeMore a {
        font-size: 14px; color: #555555; font-family: "Satoshi"; font-weight: 400; display: block; position: relative; background: #f4f4f4; 
        padding: 0px 10px 0 27px; border-radius: 8px; border: 1px solid #f4f4f4; line-height: 26px; height: 28px;
    }
    .subTitle-B .btn-seeMore a::after {
        content: "+"; display: block; position: absolute; top: -2px; left: 9px; font-size: 20px; font-weight: 700; color: #005bf1;
    }
</style>

<?
    // 이달의 구매금액 계산
    $day51 = date("Y-m-d", mktime(0, 0, 0, date("m"), 1, date("Y"))); // 이번 달 첫 날
    $day52 = date("Y-m-d", mktime(0, 0, 0, date("m") + 1, 0, date("Y"))); // 이번 달 마지막 날

    $d1 = explode("-", $day51);
    $date1 = mktime(0, 0, 0, $d1[1], $d1[2], $d1[0]);
    $d2 = explode("-", $day52);
    $date2 = mktime(0, 0, 0, $d2[1], $d2[2] + 1, $d2[0]);

    $addWhere = " a.MID = '" . $MID . "' AND a.Oregdate >= '" . $date1 . "' AND a.Oregdate < '" . $date2 . "'";

    $sql = "SELECT SUM(sub.AMT) AS AMT
            FROM (
                SELECT a.IDX, 
                SUM(IFNULL(b.AMT, 0) + IFNULL(b.OusePoint, 0) + IFNULL(b.OuseGift, 0) + IFNULL(b.OuseCoupon, 0)) AS AMT
                FROM 2011_orderInfo AS a
                LEFT JOIN 2011_orderPayment AS b ON a.IDX = b.OIDX
                WHERE a.Odeleted = 0
                AND {$addWhere}
                AND a.OpayState <> 88
                GROUP BY a.IDX
            ) AS sub";
    $rs = sql_fetch($sql);
    $thisMonthTotal = $rs['AMT'] ? number_format($rs['AMT'], 2, '.', '') : '0.00';
?>
<div class="subTop-A">
    <div class="subTitle-A">Your Account</div>
    <div class="dropdown-menu">
        <div class="dropdown-button">Account Options</div>
        <div class="dropdown-list" style="width: 184px;">
            <a href="/mypage/shippingReturn.html">Return & Refund Detail</a>
            <a href="/mypage/shippingCancel.html">Cancel Detail</a>
            <a href="/mypage/out.html">Delete Account</a>
        </div>
    </div>
</div>
<div class="info_help flex-col-spacer">
    <div class="flex-row-spacer" style="border-bottom: 1px solid #dedede; padding: 0 0 20px 0;">
        <div class="info-basic">
            <strong>Welcome, <?=$MID?>!</strong>
            <div class="flex-row-gap16">
                <span><img src="/img/mypage/ico-mypage-basic01.svg" alt="User Name"> <?= htmlspecialchars($dbMname) ?></span>
                <span><img src="/img/mypage/ico-mypage-basic02.svg" alt="User Phone"> <?= htmlspecialchars($dbMtel) ?></span>
                <span><img src="/img/mypage/ico-mypage-basic03.svg" alt="User Address"> <?= htmlspecialchars($dbMaddr1 . " " . $dbMaddr2) ?></span>
            </div>
        </div>
        <button type="button" class="btn-style btn-color-white btn-h32 btn-round" onclick="location.href='/mypage/myinfo.html'">Edit Info</button>
    </div>
    <div class="flex-row-spacer" style="margin-top: 20px;">
        <div class="info-total">
            <span>This Month's Total</span><br>
            <span>USD <strong><span id="counter1"></span></strong></span>
        </div>
        <ul class="my-button-list">
            <li onClick="location.href='/mypage/shipping.html'">
                <div class="content-items">
                    <img src="/img/mypage/img-my-receipt.svg" alt="Your Orders">
                    <span>Your Orders</span>
                </div>
            </li>
            <li onClick="location.href='/mypage/qna.html'">
                <div class="content-items">
                    <img src="/img/mypage/img-my-inquiries.svg" alt="1:1 Inquiries">
                    <span>1:1 Inquiries</span>
                </div>
            </li>
            <li onClick="location.href='/mypage/wish.html'">
                <div class="content-items">
                    <div class="count"><?=number_format($WishCount);?></div>
                    <img src="/img/mypage/img-my-wishlist.svg" alt="Wishlist">
                    <span>Wishlist</span>
                </div>
            </li>
            <li onClick="location.href='/mypage/zzim.html'">
                <div class="content-items">
                    <div class="count"><?=number_format($BrandCount);?></div>
                    <img src="/img/mypage/img-my-brands.svg" alt="Favorite Brands">
                    <span>Favorite Brands</span>
                </div>
            </li>
            <li onClick="alert('Service under preparation. We apologize for the inconvenience.'); return false;">
                <div class="content-items">
                    <img src="/img/mypage/img-my-restocked.svg" alt="Back in Stock">
                    <span>Back in Stock</span>
                </div>
            </li>
        </ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 드롭다운 메뉴 토글
        const dropdownButton = document.querySelector('.dropdown-button');
        const dropdownList = document.querySelector('.dropdown-list');

        dropdownButton.addEventListener('click', function() {
            dropdownList.classList.toggle('active');
            dropdownButton.classList.toggle('active');
        });

        // 외부 클릭 시 드롭다운 닫기
        document.addEventListener('click', function(event) {
            if (!dropdownButton.contains(event.target) && !dropdownList.contains(event.target)) {
                dropdownList.classList.remove('active');
                dropdownButton.classList.remove('active');
            }
        });

        // 이달의 총 구매금액 numberCounter
        function numberCounter(target_frame, target_number) {
            this.count = 0;
            this.diff = 0;
            this.target_count = parseFloat(target_number) || 0;
            this.target_frame = document.getElementById(target_frame);
            this.timer = null;
            this.start_time = Date.now();
            this.max_duration = 500; // 최대 애니메이션 시간 500ms
            this.counter();
        }
        numberCounter.prototype.counter = function() {
            var self = this;
            this.diff = this.target_count - this.count;
            
            if (this.diff > 0) {
                // 동적 단계 수: 금액 크기에 비례 (최소 10, 최대 50)
                var steps = Math.min(Math.max(Math.floor(this.target_count / 10), 10), 50);
                self.count += this.diff / steps;
                if (self.count > this.target_count) {
                    self.count = this.target_count; // 초과 시 목표값으로 고정
                }
            }
            
            if (this.target_frame) {
                this.target_frame.innerHTML = this.count.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
                console.error('Target frame not found: ' + target_frame);
            }
            
            // 최대 시간 초과 또는 목표값 도달 시 종료
            if (Date.now() - this.start_time < this.max_duration && Math.abs(this.count - this.target_count) > 0.01) {
                this.timer = setTimeout(function() { self.counter(); }, 20); // 20ms 간격
            } else {
                this.target_frame.innerHTML = this.target_count.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                clearTimeout(this.timer);
            }
        };
        
        // 디버깅 로그
        console.log('Counter1 element:', document.getElementById('counter1'));
        console.log('This month total:', '<?=$thisMonthTotal?>');
        
        // 이달의 구매금액 초기화
        new numberCounter("counter1", '<?=$thisMonthTotal?>');
    });
</script>