<?
	include_once $_SERVER['DOCUMENT_ROOT']."/_common.php";

	include_once $_SERVER['DOCUMENT_ROOT']."/top.html";
	
	include_once $_SERVER['DOCUMENT_ROOT']."/mypage/common.html";	

	#======== 날짜 구하기 =======================
	//-- 오늘
	$day11 = date("Y-m-d");
	$day12 = date("Y-m-d");

	//-- 어제
	$day21 =date("Y-m-d",strtotime("-1 day"));
	$day22 =date("Y-m-d",strtotime("-1 day"));

	//-- 이번주
	$day31 =date("Y-m-d",strtotime("last Monday"));
	$day32 =date("Y-m-d",strtotime("next Sunday"));

	//-- 지난주
	$day41 =date("Y-m-d",strtotime("-1 week last Monday"));
	$day42 =date("Y-m-d",strtotime("-1 week next Sunday"));

	//-- 이번달
	$day51 =date("Y-m-d",mktime(0,0,0,date("m"),1,date("Y")));
	$day52 =date("Y-m-d",mktime(0,0,0,date("m"),31,date("Y")));

	//-- 최근한주
	$day61 =date("Y-m-d",strtotime("-6 day"));
	$day62 =date("Y-m-d");

	//-- 최근한달
	$day71 =date("Y-m-d",strtotime("-30 day"));
	$day72 =date("Y-m-d");

	// -- 한달
	$day81 =date("Y-m-d",strtotime("-30 day"));
	$day82 =date("Y-m-d");

?>
<link rel="stylesheet" type="text/css" href="/mypage/mypage.css?250221">
<link href='/css/button.css' rel='stylesheet' type='text/css'>

<!-- 마이페이지 시작 --->    
<div id="wrap">

	<?	include_once $_SERVER['DOCUMENT_ROOT']."/mypage/menu.html"; ?>
	
	<!-- mypageMain -->
	<div id="mypageMain">
	
	<? include_once $_SERVER['DOCUMENT_ROOT']."/mypage/top.html"; ?>      
	
	<?			

		/*=======================================================================================
		 검색 조건문 만들기
		 =======================================================================================*/
		$sql = " SELECT a.*, b.MID, e.McomName, e.MKIND, SUM(a.RCOUNT * a.PRICE) AS TPRICE, ";
		$sql .= " SUM(if(a.KIND = '1' , a.RCOUNT , null)) as RCOUNT1 , SUM(if(a.KIND = '2' , a.RCOUNT , null)) as RCOUNT2 ";
		$sql .= " FROM 2011_orderReturn AS a ";
		$sql .= " LEFT JOIN 2011_orderInfo AS b ON a.OIDX = b.IDX ";
		$sql .= " LEFT JOIN 2011_memberInfo AS e ON b.MID = e.MID ";

		$where = " WHERE b.OpayState<>88 AND b.Odeleted != 1 AND b.MID = '$MID' ";
		
		if($s3){
			if($where)$where.=" and ";
			$where.=" Oname LIKE '%$s3%' ";
		}

		if($s9 || $s10)
		{	
			if($s9)
			{
				$d1 = explode("-",$s9);
				$date1 = mktime(0,0,0,$d1[1],$d1[2],$d1[0]);
			}
			if($s10)
			{
				$d2 = explode("-",$s10);
				$date2 = mktime(0,0,0,$d2[1],($d2[2]+1),$d2[0]);
			}			
		}
		else 
		{
			$s9 = $day51;
			$d1 = explode("-",$s9);
			$date1 = mktime(0,0,0,$d1[1],$d1[2],$d1[0]);

			$s10 = $day52;
			$d2 = explode("-",$s10);
			$date2 = mktime(0,0,0,$d2[1],($d2[2]+1),$d2[0]);
		}


		if($where)$where.=" and ";
		$where.=" GROUPCODE  between '" . $date1 . "' and  '" . $date2 . "' ";
		
		$sql .= $where;
		$sql .= " GROUP BY a.GROUPCODE ";
		$sql .= " ORDER BY a.RIDX DESC ";

		$sqlExcel = urlencode($sql);

		$result = sql_query($sql);
		$TotalCount = mysqli_num_rows($result);
		if (!$page) $page = 1;
		if (!$listSize) $listSize = 10;
		$CntPerPage = $listSize;
		$PagePerList = 5;
		$StartPos = ($page - 1) * $CntPerPage;
		$sql .= " LIMIT ".($page - 1) * $CntPerPage.",".$CntPerPage;
		$result = sql_query($sql);
		
		$option = "&listSize=".$listSize."&s3=".urlencode($s3)."&s4=".$s4."&s9=".$s9."&s10=".$s10;
?>

<div class="qa_list">
	<h3><img src="/img/mypage/tit_10.gif" alt="나의주문취소내역조회"></h3>

	<table border="0" cellspacing="0" cellpadding="0" style="width: 100%; height: 40px; border: 0px;">
	<form name="xform" id="xform">
		<tr>
			<td style="padding:3px 0 0 0; margin:0px; border-bottom:0px;">
				<b>Recipient</b>
				<input type='text' value='<?=$s3?>' id='s3' name='s3' size=15>
				&nbsp;&nbsp;
				<select name="s4" id="s4">
					<option value="1" <? if($s4 == 1) echo "selected"; ?>>Date of Return</option>
				</select>
				<input type='text' value='<?=$s9?>' id='s9' name='s9' readonly tabindex='-1' size=7 style='cursor:pointer; width: 112px;' >
				~
				<input type='text' value='<?=$s10?>' id='s10' name='s10' readonly tabindex='-1' size=7 style='cursor:pointer; width: 112px;' >
				&nbsp;&nbsp;
				<span class='button medium icon' style='margin-top:6px;'><span class='refresh'></span><input type='button' value='&nbsp;SEARCH&nbsp;' onclick='document.getElementById("xform").submit();'  /></span>
			</td>
		</tr>
	</table>
	</form>

	<table border="0" cellspacing="0" cellpadding="0">
	<form name="formObject" id="formObject" method="post" action="/mypage/goExcelReturn.php" target="Hiframe">
	<input type="hidden" name="pQuery" value="<?=$sqlExcel?>">
		<tr>
			<th scope="col" style="line-height:120%;width:45px;">Date of<br/>Return</th>
			<th scope="col" style="width:80px;">Order No.</th>
			<th scope="col" style="width:50px;">Recipient</th>
			<!--<th scope="col">Item</th>-->
			<th scope="col" style="line-height:120%;width:44px;">Qty of<br>Return</th>
			<th scope="col" style="line-height:120%;width:40px;">Qty of<br>Defect</th>
			<th scope="col" style="line-height:120%;width:65px;">Total<br>Amount</th>
			<th scope="col" style="line-height:120%;width:45px;">Shipping<br>Rates</th>
			<th scope="col" style="line-height:120%;width:65px;">Deposit<br>Amount</th>
			<th scope="col" class="none" style="line-height:120%;width:55px;">Refund<br>Status</th>
		</tr>
		<?
			while($rs=sql_fetch_array($result)){
	
				# DB 레코드 결과값 모두 변수로 전환
				foreach ($rs as $fieldName => $fieldValue){$fieldName = "db" . $fieldName;$$fieldName = $fieldValue;}


				$query2 = " SELECT a.*,b.Ocode,b.Oname FROM 2011_orderReturn a LEFT JOIN 2011_orderInfo b ON a.OIDX = b.IDX WHERE b.MID = '$MID' AND GROUPCODE = '$dbGROUPCODE'";
				$result2 = sql_query($query2);
				$cnt = mysqli_num_rows($result2);
				$k = 0;
				while($data = sql_fetch_array($result2)){
					$k ++;
					
					$query3 = " SELECT * FROM `2011_orderProduct` WHERE OIDX = '$data[OIDX]' AND PIDX = '$data[PIDX]' AND ORPoption = '$data[OPIDX]' ";
					$data3 = sql_fetch($query3);
					
					if($k == 1)	{
						$de = sql_fetch(" SELECT * FROM 2011_orderReturnDelivery WHERE DRIDX = '$dbGROUPCODE' ");
						if($de[AMOUNT] == "") $de[AMOUNT] = 0;
						$tAmount = $dbTPRICE + $de[AMOUNT];
						
						if($de[RDSTATUS]==1) {
							$css="color:red;";
							$GFconstate="X";
						} else if($de[RDSTATUS]==2) {
							$css="color:blue;";
							$GFconstate="O";
						} else if($de[RDSTATUS]==3)	{
							$css="color:green;";
							$GFconstate="C";
						} else if($de[RDSTATUS] == 4){
							$css="color:green;";
							$GFconstate="Cash";
						}
					}
		?>
		<tr>
			<? if($k == 1){ ?><td rowspan="<?=$cnt?>" style="font-size:11px;"><?=str_replace("-","/",substr($dbRDATE,2,8))?></td><? } ?>
			<td style="line-height:120%;font-size:11px;"><a href='shippingDetail.html?kind=return&Ocode=<?=$data[Ocode]?>&page=<?=$page?><?=$option?>'><?=$data[Ocode]?></a></td>
			<td style="line-height:120%;"><?=$data[Oname]?></td>		
			<!--<td style="line-height:120%;padding:5px 0px;"><a href='/product/view.html?qIDX=<?=$data["PIDX"]?>' target='_blank'><?=$data3["ORPname"]?></a><? if($data3["ORPoptionValue"]){ ?><br/>(<?=$data3["ORPoptionName"]?>-<?=$data3["ORPoptionValue"]?>)<? } ?></td>-->
			<td style="line-height:120%;"><? if($data[KIND] == 1) { echo $data[RCOUNT]; } ?></td>
			<td style="line-height:120%;"><? if($data[KIND] == 2) { echo $data[RCOUNT]; } ?></td>
			<td style="line-height:120%;"><?=number_format($data[PRICE] * $data[RCOUNT]);?></td>
			<? if($k == 1){ ?><td rowspan="<?=$cnt?>" style="line-height:120%;"><?=number_format($de[AMOUNT])?></td><? } ?>
			<? if($k == 1){ ?><td rowspan="<?=$cnt?>" style="line-height:120%;"><?=number_format($tAmount)?></td><? } ?>
			<? if($k == 1){ ?><td rowspan="<?=$cnt?>" style='font-size:14px;font-weight:bold;<?=$css?>'><?=$GFconstate?></td><? } ?>
		</tr>
		<? 
				}
			}
		?>
	</form>
	</table>

	<!-- //마이페이지 주문확인/배송조회 -->
	</div>        

	<div align="center" id="paging"><? echo page_nav($TotalCount,$CntPerPage,$PagePerList,$page,$option); ?></div>

	</div>

</div>
<!-- //마이페이지 끝 ---> 

<script>
$(function() {
	$( "#s9, #s10" ).datepicker({
		dateFormat: 'yy-mm-dd',
		prevText: '이전 달',
		nextText: '다음 달',
		monthNames: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
		monthNamesShort: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
		dayNames: ['일','월','화','수','목','금','토'],
		dayNamesShort: ['일','월','화','수','목','금','토'],
		dayNamesMin: ['일','월','화','수','목','금','토'],
		showMonthAfterYear: true,
		changeMonth: true,
		changeYear: true,
		yearRange: 'c-2:c+2',
		yearSuffix: '년'
	});
});
</script>
 
<?
	include_once $_SERVER['DOCUMENT_ROOT']."/footer.html";
?>