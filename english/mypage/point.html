<?
	include_once $_SERVER['DOCUMENT_ROOT']."/_common.php";

	include_once $_SERVER['DOCUMENT_ROOT']."/top.html";
	
	include_once $_SERVER['DOCUMENT_ROOT']."/mypage/common.html";	
?>
<link rel="stylesheet" type="text/css" href="/mypage/mypage.css?2211">

<!-- 마이페이지 시작 --->
<div id="wrap">

	<?
		include_once $_SERVER['DOCUMENT_ROOT']."/mypage/menu.html";
	?>
	
	<!-- mypageMain -->
	<div id="mypageMain">
	<?
		include_once $_SERVER['DOCUMENT_ROOT']."/mypage/info.html";
	?>
	
	<?
		$nPoint = fnGetMemberTotalPoint($MID);

		if(!$sYear) $sYear = date("Y");
		if(!$sMonth && $act != "ok") $sMonth = date("m");

		if($sYear == 0){
		} else {
			$dWhere .= " AND FROM_UNIXTIME(POregdate, '%Y') = '$sYear'  ";
		}
		if($sMonth == "0" && $act == "ok"){
		} else {
			$dWhere .= " AND FROM_UNIXTIME(POregdate, '%m') = '$sMonth'  ";
		}
		$option .= "&act=".$act."&sYear=".$sYear."&sMonth=".$sMonth;

		$query = "select a.IDX,sum(a.POpoint * a.POcount) as TPoint,a.POstate,a.POregdate,a.OIDX,a.POcontent,b.Ocode from 2011_memberPoint as a left join 2011_orderInfo as b on a.OIDX = b.IDX where a.MID='" . $MID . "' and a.POdeleted=0 AND (b.Odeleted=0 or b.Odeleted IS NULL ) ".$dWhere." group by POregdate ,POtype";
		$result = sql_query($query);
		$TotalCount = mysqli_num_rows($result);
		if (!$page) $page = 1;
		$CntPerPage = 10;
		$PagePerList = 5;
		$StartPos = ($page - 1) * $CntPerPage;
		$query .= " ORDER BY IDX DESC";
		$query .= " LIMIT ".($page - 1) * $CntPerPage.",".$CntPerPage;
		$result = sql_query($query);
	?>
          <div class="qa_list">
                      
            <h3><img src="/img/mypage/tit_point_view.gif" alt="나의포인트내역"></h3>
                        
            <div class="info_mypoint">
            <span class="use_point"><?=number_format($nPoint)?>P</span>
            <span class="point_text">
            * 반품 및 환불은 해당 금액을 포인트로 적립해드립니다.<br>
            * 포인트는 1포인트(원)부터 사용 가능합니다.<br>
            * 상품 구매 시 포인트는 적립되지 않습니다.</span>
            </div>  
			<script>
				function goSearch(){
					document.getElementById("xform").submit();
				}
			</script>
			<form name="xform" id="xform" method="get">
			<input type="hidden" name="act" value="ok">
            <div class="period_select">
            <strong>날짜조회</strong>
            <select name="sYear" id="sYear" class="" onclick="">
				<?
					$endYear = date("Y") + 2;
					for($i = 2014; $i < $endYear; $i ++){
						if($sYear){
							if($i == $sYear) $sel = "selected";
							else $sel = "";
						} else {
							if($i == date("Y")) $sel = "selected";
							else $sel = "";
						}
				?>
				<option value="<?=$i?>" <?=$sel?>><?=$i?></option>
				<? } ?>
            </select> 년
            <select name="sMonth" id="sMonth" class="" onclick="">
				<option value="0">전체</option>
				<?
					for($i = 1; $i < 13; $i ++){
						if(strlen($i) == 1) $iMonth = "0".$i;
						else $iMonth = $i;
						if($sMonth){
							if($iMonth == $sMonth) $sel = "selected";
							else $sel = "";
						}
				?>
				<option value="<?=$iMonth?>" <?=$sel?>><?=$iMonth?></option>
				<? } ?>
            </select>  월
            <img type="image" src="/img/mypage/btn_search.gif" width="41" height="18" alt="검색" onClick="goSearch();" style="cursor:pointer">
            </div>
			</form>

			<table border="0" cellspacing="0" cellpadding="0">
				<tr>
                    <th scope="col">NO</th>
                    <th scope="col">일자</th>
                    <th scope="col">내용</th>
                    <th scope="col">적립금액</th>
                    <th scope="col">사용금액</th>
                    <th scope="col" class="none">상태</th>
                </tr>
				<?
					$no = $TotalCount - $StartPos;
					while($rs = sql_fetch_array($result)){
						
						# DB 레코드 결과값 모두 변수로 전환
						foreach ($rs as $fieldName => $fieldValue){$fieldName = "db" . $fieldName;$$fieldName = $fieldValue;}
					
						$pointPlus=0;
						$pointMinus=0;
						$stStr = "";
						if($dbTPoint>=0)$pointPlus=$dbTPoint;
						else $pointMinus=$dbTPoint;
					
						if($dbPOstate==2)
							$stStr="<font class=orange>완료</font>";
						else
							$stStr="<font class=blue>대기중</font>";
										
						$dbOcode="";
						if(!$dbOcode)$dbOcode=$dbPOcontent ;								
				?>
                <tr>
					<td><?=$no?></td>
                    <td class="qa_time"><?=date("Y-m-d H:i",$dbPOregdate)?></td>
                    <td><?=$dbOcode?>
					<?
						if($dbOIDX){
							$getOIDX = sql_fetch("SELECT * FROM 2011_orderInfo WHERE IDX = '$dbOIDX'");
							echo " (".$getOIDX[Ocode].")";
						}
					?>
					</td>
                    <td><?=number_format($pointPlus)?> P</td>
                    <td><?=number_format($pointMinus)?> P</td>
                    <td><?=$stStr?></td>
                </tr>
				<? 
						$no --;
					}
				?>                
            </table>

			<div align="center" id="paging"><? echo page_nav($TotalCount,$CntPerPage,$PagePerList,$page,$option); ?></div>
		</div>
		
		<!-- //나의포인트내역 -->
	</div>
	
</div>
<!-- //마이페이지 끝 ---> 

<?
	include_once $_SERVER['DOCUMENT_ROOT']."/footer.html";
?>